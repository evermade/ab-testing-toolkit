/*!  @evermade/ab-testing-toolkit 1.0.0 */
function e(){const e=new Map,t=[],a="ab-test-manager",n=()=>(new Date).getTime(),o=()=>{let e={};const t=localStorage.getItem(a);if(t){try{e=JSON.parse(t)}catch(e){console.error(e),localStorage.removeItem(a)}const o=n();try{const t=Object.values(e).filter((e=>e.expiration>o));t.length!==Object.values(e).length&&(e={},t.forEach((t=>{e[t.testId]=t})))}catch(t){e={},console.error(t),localStorage.removeItem(a)}}return Object.values(e).length>0?e:{}},r=(e,t)=>{const r=o(),s={testId:e,variantSlug:t,expiration:n()+31536e6};r[e]=s,localStorage.setItem(a,JSON.stringify(r))};return{register:t=>{t=Object.assign({debug:!1,useDataLayer:!0},t);if(new URLSearchParams(window.location.search).get("ab-test-debug")&&(t.debug=!0),(e=>{const{id:t,variants:a}=e;if(!t)throw new Error("A test ID is required");if(!a||a.length<2)throw new Error("A test must have at least 2 variants");a.forEach((e=>{const{name:t,slug:a}=e;if(!t)throw new Error("A variant must have a name");if(!a)throw new Error("A variant must have a slug")}))})(t),e.set(t.id,t),t.debug){const e=window.location.href.split("?")[0],a=t.variants.map((a=>`| Variant: ${a.name} (slug: ${a.slug}) => ${e}?ab-test=${t.id}&ab-variant=${a.slug}`));console.log(`🧑‍⚕️ [${t.id}]: Test registered: ${t.name}`,...a)}},run:a=>{const n=e.get(a);if(!n)return void console.log(`🧑‍⚕️ [${a}] No test by id`);const{variants:s,debug:l,onBeforeRun:i,onAfterRun:c,useDataLayer:g,dataLayerEventName:u}=n;let d;const m=new URLSearchParams(window.location.search),f=m.get("ab-test"),h=m.get("ab-variant");if(f===a&&h){const e=s.find((e=>e.slug===h));e&&(d=e,l&&console.log(`🧑‍⚕️ [${a}] Variant chosen by URL parameter: ${null==d?void 0:d.name}`))}if(!d){const e=(e=>{const t=o()[e];return!!t&&t.variantSlug})(a);if(e){const t=s.find((t=>t.slug===e));t&&(d=t,l&&console.log(`🧑‍⚕️ [${a}] Variant chosen by local storage: ${null==d?void 0:d.name}`))}}if(!d){d=s[Math.floor(Math.random()*s.length)],r(a,d.slug),l&&console.log(`🧑‍⚕️ [${a}] Variant randomly chosen: ${null==d?void 0:d.name}`)}if(t.includes(a)&&l&&console.warn(`🧑‍⚕️ [${a}] Multiplte runs of test`),d){if(l&&console.log(`🧑‍⚕️ [${a}] Running...`),i&&i(d),"function"==typeof d.onRun&&d.onRun(),c&&c(d),t.push(a),g){const e={event:u||"ABTest",testId:a,testName:n.name,variantSlug:d.slug,variantName:d.name};l&&console.log(`🧑‍⚕️ [${a}] Pushing data layer...`,e),window.dataLayer=window.dataLayer||[],window.dataLayer.push(e)}l&&console.log(`🧑‍⚕️ [${a}] Ready`)}else console.log(`🧑‍⚕️ [${a}] No variant selected for test`)},deleteSavedVariant:e=>{const t=o();delete t[e],localStorage.setItem(a,JSON.stringify(t))}}}export{e as abTestManager};
